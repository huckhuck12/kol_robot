# KOL交易信号推送系统

一个自动从KOL平台获取交易信号并推送到钉钉机器人的系统。

## 功能特点

- 📊 **自动抓取**：定时从API获取最新的KOL交易信号
- 🔔 **钉钉推送**：将新的交易信号实时推送到钉钉机器人
- ⏰ **灵活的轮询机制**：支持两种运行模式
  - GitHub Actions短轮询（推荐，每3分钟执行一次）
  - 本地持续轮询（适合本地部署）
- 📝 **智能去重**：自动避免重复推送
  - GitHub Actions模式：基于时间筛选，只处理最近10分钟内的信号
  - 本地模式：通过本地文件记录已处理信号ID
- 📋 **结构化信号**：提取完整的交易信息（交易对、方向、价格、杠杆等）
- 🔧 **易于配置**：通过配置文件即可调整系统参数
- 💻 **跨平台支持**：支持Windows、Linux、MacOS

## 技术栈

- **Node.js**：运行环境
- **axios**：HTTP请求库，用于模拟浏览器访问API
- **crypto**：生成钉钉机器人签名
- **GitHub Actions**：用于自动化短轮询

*注：已移除node-schedule依赖，改用setInterval实现本地轮询，GitHub Actions实现自动化短轮询*

## 项目结构

```
kol_robot/
├── .github/workflows/         # GitHub Actions配置
│   └── run-signal-check.yml  # 定时执行配置
├── config.js                  # 配置文件
├── package.json               # 项目依赖
├── README.md                  # 项目说明
├── data/
│   └── processedSignals.json  # 已处理信号记录
└── src/
    ├── api.js                 # API访问模块
    ├── dataProcessor.js       # 数据处理模块
    ├── dingTalk.js            # 钉钉推送模块
    ├── storage.js             # 本地存储模块
    └── index.js               # 主程序入口（支持两种运行模式）
```

## 安装使用

### 1. 克隆仓库

```bash
git clone https://github.com/huckhuck12/kol_robot.git
cd kol_robot
```

### 2. 安装依赖

```bash
npm install
```

### 3. 配置系统

编辑 `config.js` 文件，配置以下参数：

```javascript
module.exports = {
  // API配置
  api: {
    url: 'http://kol.zhixing.icu/api/user/proxy/frontend-messages',
    params: {
      type: 'all',
      limit: 100
    },
    // ...
  },

  // 钉钉机器人配置
  dingTalk: {
    webhook: '你的钉钉机器人webhook地址',
    secret: '你的钉钉机器人加签密钥'
  },

  // 定时任务配置（单位：分钟）
  schedule: {
    interval: 5
  },
  // ...
};
```

### 4. 启动系统

#### 4.1 本地持续轮询模式（适合本地部署）

```bash
npm start
```
- 立即执行一次轮询
- 按配置间隔（默认5分钟）持续执行
- 按Ctrl+C优雅退出

#### 4.2 本地单次执行模式（适合测试和调试）

```bash
node src/index.js --single
```
- 执行一次轮询后自动退出
- 适合测试和调试

#### 4.3 GitHub Actions自动模式（推荐，无需本地运行）

项目已配置GitHub Actions，会自动：
- 每3分钟执行一次轮询
- 推送新信号到钉钉
- 基于时间筛选新信号，只处理最近10分钟内的信号

无需本地运行，GitHub Actions会自动处理所有流程

## 配置说明

### API配置

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `url` | API地址 | `http://kol.zhixing.icu/api/user/proxy/frontend-messages` |
| `params.type` | 消息类型 | `all` |
| `params.limit` | 返回数量限制 | `100` |
| `headers` | 请求头配置 | 模拟浏览器请求头 |
| `retry.times` | 重试次数 | `3` |
| `retry.delay` | 重试间隔（毫秒） | `1000` |

### 钉钉机器人配置

| 参数 | 说明 |
|------|------|
| `webhook` | 钉钉机器人webhook地址 |
| `secret` | 钉钉机器人加签密钥 |

### 定时任务配置

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `interval` | 执行间隔（分钟） | `5` |

## 钉钉消息格式

系统推送的钉钉消息采用**Markdown表格格式**，包含以下信息：

| **项目** | **详情** |
|----------|----------|
| 📈 交易对 | 如 BTC/USDT、ETH/USDT 等 |
| ➡️ 方向 | 多头或空头 |
| 🎯 入场价 | 建议的入场价格 |
| 🛑 止损 | 建议的止损价格 |
| 🎯 目标价 | 建议的目标价格 |
| 🔢 杠杆 | 建议的杠杆倍数 |
| 📢 频道 | 信号发布的频道 |
| ⏰ 时间 | 信号发布时间（北京时间） |

**分析理由**：KOL的详细分析和理由

### 消息样式特点
- 🎨 采用Markdown表格，排版清晰美观
- ⏰ 显示正确的北京时间，已修复时区问题
- 🏆 结构化信息，便于快速查看关键数据
- 💡 分析理由独立展示，便于阅读完整分析

## 运行日志

### 本地持续轮询模式日志

系统启动后，会在控制台输出以下日志：

```
============================================================
KOL交易信号推送系统 - 本地持续轮询模式
============================================================
🔄 轮询间隔：5分钟
📅 首次执行：立即执行
🔔 按 Ctrl+C 停止
============================================================
============================================================
KOL交易信号推送系统 - 单次轮询
============================================================
✅ 配置检查完成
🔍 正在获取KOL交易信号...
📥 获取到 X 条消息
📋 提取到 X 个有效信号
🔔 所有信号都已处理过
✅ 单次轮询任务完成
============================================================
```

### 单次执行模式日志

执行单次轮询时，会输出以下日志：

```
============================================================
KOL交易信号推送系统 - 单次轮询
============================================================
✅ 配置检查完成
🔍 正在获取KOL交易信号...
📥 获取到 16 条消息
📋 提取到 3 个有效信号
✨ 发现 2 个新信号
📤 开始推送信号到钉钉...
✅ 钉钉推送成功：Sherlock - BERA
✅ 钉钉推送成功：山寨之王 - 芷楹
📊 推送结果：成功 2 个，失败 0 个
✅ 单次轮询任务完成
============================================================
```

## 注意事项

1. **API限制**：API可能有访问频率限制，建议不要将执行间隔设置得太短
2. **钉钉机器人配置**：请确保钉钉机器人的webhook和密钥正确配置
3. **依赖版本**：建议使用指定版本的依赖包，避免兼容性问题
4. **日志监控**：定期查看日志，确保系统正常运行
5. **GitHub Actions权限**：已配置必要的权限，确保工作流正常运行
6. **本地与GitHub Actions协同**：两种模式使用同一套代码和配置，可根据需要选择运行方式
7. **已处理信号记录**：
   - 本地模式：`processedSignals.json`文件会自动更新，请勿手动修改
   - GitHub Actions模式：基于时间筛选新信号，无需持久化记录
8. **时间显示**：已修复时区问题，所有信号时间显示为北京时间

## 常见问题

### Q: 为什么没有收到钉钉推送？
A: 请检查以下几点：
1. 钉钉机器人的webhook和密钥是否正确配置
2. 是否有新的交易信号（系统只推送新信号）
3. 查看日志是否有错误信息
4. 检查GitHub Actions运行是否正常

### Q: 如何修改定时任务间隔？
A: 在`config.js`文件中修改`schedule.interval`参数，单位为分钟

### Q: 如何添加更多的KOL？
A: 系统会自动从API获取所有KOL的信号，无需手动添加

### Q: GitHub Actions运行失败怎么办？
A: 请检查以下几点：
1. 查看GitHub Actions运行日志，了解具体错误信息
2. 检查仓库是否有写入权限
3. 检查API地址是否可访问
4. 确认钉钉机器人配置是否正确

### Q: 如何切换运行模式？
A: 
- 本地持续轮询：直接运行`npm start`
- 本地单次执行：运行`node src/index.js --single`
- GitHub Actions自动模式：无需手动操作，会自动定时执行

### Q: 为什么本地运行和GitHub Actions的结果不一致？
A: 可能是由于以下原因：
1. 运行时间不同，API返回的数据可能不同
2. 本地和GitHub Actions使用的配置可能不同
3. 已处理信号记录可能不同步

### Q: 如何查看GitHub Actions的运行日志？
A: 
1. 访问GitHub仓库页面
2. 点击顶部的"Actions"标签
3. 在左侧选择"KOL交易信号检查与推送"
4. 点击任意一条运行记录，查看详细日志

### Q: 如何调整GitHub Actions的执行频率？
A: 修改`.github/workflows/run-signal-check.yml`文件中的cron表达式

### Q: 本地运行时如何优雅退出？
A: 按Ctrl+C即可优雅退出，系统会停止当前的定时任务

## 许可证

ISC

## 贡献

欢迎提交Issue和Pull Request！
